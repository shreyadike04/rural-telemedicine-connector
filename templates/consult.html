<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consult Online - Rural Telemedicine Connector</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://meet.jit.si/external_api.js"></script>
  <style>
    .help-text {
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
      display: block;
    }
    textarea {
      resize: vertical;
    }
  </style>
  <script>
    async function handleConsult(event) {
      event.preventDefault();
      
      const name = document.getElementById("name").value;
      const age = document.getElementById("age").value;
      const symptoms = document.getElementById("symptoms").value;
      const mode = document.getElementById("mode").value;

      try {
        const response = await fetch('/api/consultations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            patient_name: name,
            age: age,
            symptoms: symptoms,
            mode: mode
          })
        });

        const data = await response.json();
        
        if (response.ok) {
  // parse data
  const result = data; // already parsed above as `const data = await response.json();`
  if (mode === "video" && result.room_url) {
    // open the room in a new window (patient side)
    window.open(result.room_url, "_blank", "noopener");
    alert("✅ Video room opened. Please share the window/tab with the doctor or have the doctor open the same link.");
    window.location.href = "{{ url_for('index') }}";
  } else if (mode === "audio" && result.room_url) {
    // open audio-only room (use the audio_only param)
    const audioUrl = result.room_url + "?audio_only=1";
    window.open(audioUrl, "_blank", "noopener");
    alert("✅ Audio room opened.");
    window.location.href = "{{ url_for('index') }}";
  } else {
    // chat / fallback
    alert("✅ Your consultation request has been submitted successfully!");
    window.location.href = "{{ url_for('index') }}";
  }
}
 else {
        alert(`❌ Error: ${data.error}`);
      }
    } catch (error) {
      alert('❌ Network error. Please try again.');
      console.error('Error:', error);
    }
  }
  // Show popup
  function showPopup(type, callback) {
    const popup = document.createElement("div");
    popup.innerHTML = `
      <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:20px;border-radius:10px;text-align:center;">
          <h3>${type} Consultation</h3>
          <p>Click below to start your ${type.toLowerCase()} consultation.</p>
          <button id="startCallBtn">Start ${type}</button>
          <button onclick="this.parentElement.parentElement.remove()">Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(popup);
    document.getElementById("startCallBtn").onclick = () => {
      popup.remove();
      callback();
    };
  }

  // Start Video Call
  function startVideoCall() {
    const roomName = "telemedicine_" + Date.now();
    const domain = "meet.jit.si";
    const options = {
      roomName: roomName,
      width: "100%",
      height: 600,
      parentNode: document.body,
    };
    new JitsiMeetExternalAPI(domain, options);
  }

  // Start Audio Call (video muted)
  function startAudioCall() {
    const roomName = "telemedicine_" + Date.now();
    const domain = "meet.jit.si";
    const options = {
      roomName: roomName,
      width: "100%",
      height: 600,
      parentNode: document.body,
      configOverwrite: { startWithVideoMuted: true } // ✅ only audio
    };
    new JitsiMeetExternalAPI(domain, options);
  }
  </script>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <h1>Rural Telemedicine Connector</h1>
    <ul>
      <li><a href="{{ url_for('index') }}">Home</a></li>
      <li><a href="{{ url_for('doctors') }}">Doctors</a></li>
      <li><a href="{{ url_for('appointment') }}">Book Appointment</a></li>
      <li><a href="{{ url_for('consult') }}" class="active">Consult Online</a></li>
    </ul>
  </nav>

  <!-- Consultation Section -->
  <section class="consult">
    <h2>Start Your Online Consultation</h2>
    <p>Fill in your details and connect with a doctor instantly.</p>

    <form class="consult-form" onsubmit="handleConsult(event)">
      <label for="name">Full Name:</label>
      <input type="text" id="name" name="name" placeholder="Enter your name" required>

      <label for="age">Age:</label>
      <input type="number" id="age" name="age" placeholder="Enter your age" required>

      <label for="symptoms">Describe Your Symptoms:</label>
      <span class="help-text">Please include details like <b>when the symptoms started, their severity, frequency, and any medications you are taking</b>. This will help the doctor understand your condition better.</span>
      <textarea id="symptoms" name="symptoms" rows="5" placeholder="Example: I have had a persistent cough for the last 3 days with mild fever. I feel tired in the evenings and I am currently taking paracetamol." required></textarea>

      <label for="mode">Choose Consultation Mode:</label>
      <select id="mode" name="mode" required>
        <option value="">-- Select --</option>
        <option value="chat">Chat</option>
        <option value="video">Video Call</option>
        <option value="audio">Audio Call</option>
      </select>

      <button type="submit" class="btn">Start Consultation</button>
    </form>
  </section>
</body>
</html>